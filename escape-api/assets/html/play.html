{{define "styling"}}
<style>
    #lobby {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    #gameplay {
        display: none;
    }

    .hexfield {
        fill: transparent;
        stroke: yellowgreen;
        stroke-width: 1;
    }

    .hexfield:focus {
        outline: none;
    }

    .hexfield:active {
        fill: red;
        outline: none;
    }

    .hexfield.wall {
        fill: brown;
    }

    .hexfield.safe{
        fill: white;
    }

    .hexfield.dangerous{
        fill: gray;
    }

    .hexfield.pod {
        fill: black;
    }

    .hexfield.alienstart{
        fill: red;
    }

    .hexfield.humanstart{
        fill: blue;
    }
    
    .hexfield:hover {
        fill: green;
    }

    .hexfield.player{
        fill: orange;
    }
</style>
{{end}}

{{define "body"}}
<div id="lobby">
    <h3>Lobby</h3>
    <div id="lobby-roomCode"></div>
    <div id="lobby-playerList"></div>
    <div id="lobby-gameConfig">
        <input type="number" id="config-numHumans" placeholder="Human Players"/>
        <input type="number" id="config-numAliens" placeholder="Alien Players"/>
        <input type="number" id="config-numWorkingPods" placeholder="Working Pods"/>
        <input type="number" id="config-numBrokenPods" placeholder="Broken Pods"/>
    </div>
    <button id="lobby-startButton" style="display: none;">Start</button>
</div>
<div id="gameplay">
    <div id="gameplay-gridParent"></div>
</div>
{{end}}

{{define "scripts"}}
<script src="/assets/js/websocket.js"></script>
<script src="/assets/js/mapplayer.js"></script>
<script>
    var ws = null;
    var thisPlayer = null;
    var thisGameStateId = null;
    function openSocket() {
        urlParams = new URLSearchParams(window.location.search)

        var playerName = urlParams.get("playerName")
        if (!playerName?.length > 0) {
            console.error("no player name found")
            return
        }
        if (urlParams.has("mapId") && !urlParams.has("roomCode")) {
            var mapId = urlParams.get("mapId")

            var urlToConnect = `ws://${window.location.host}/lobby/host?mapId=${mapId}&playerName=${playerName}`
        } else if (urlParams.has("roomCode") && !urlParams.has("mapId")) {
            var roomCode = urlParams.get("roomCode")

            var urlToConnect = `ws://${window.location.host}/lobby/join?roomCode=${roomCode}&playerName=${playerName}`
        } else {
            console.error("Something went wrong trying to detect mode")
            return;
        }

        ws = new WebSocket(urlToConnect)

        ws.addEventListener('message', (wsMsg) => {
            var message = JSON.parse(wsMsg.data)
            handleWsMessage(message)
        })
    }

    const WS_CLOSE = "Close"
    const WS_ERROR = "Error"
    const WS_GAMESTATE = "GameState"
    const WS_GAMEOVER = "GameOver"
    const WS_LOBBYINFO = "LobbyInfo"

    function handleWsMessage(message) {
        console.info("Message inbound", message)
        switch (message.type) {
            case WS_CLOSE:
                handleCloseMessage(message.data);
                break;
            case WS_ERROR:
                handleErrorMessage(message.data);
                break;
            case WS_GAMESTATE:
                handleGameStateMessage(message.data);
                break;
            case WS_GAMEOVER:
                handleGameOverMessage(message.data);
                break;
            case WS_LOBBYINFO:
                handleLobbyInfoMessage(message.data);
                break;
        }
    }

    async function handleCloseMessage(messageData) {

    }

    async function handleErrorMessage(messageData) {

    }

    async function handleGameOverMessage(messageData) {

    }

    async function handleGameStateMessage(gameState) {
        if(!thisGameStateId){
            await initializeMap(gameState.mapId)
            thisGameStateId = gameState.id
        }
        document.getElementById("lobby").style.display = 'none';
        document.getElementById('gameplay').style.display = 'flex';
        
        document.querySelectorAll('.player').forEach(x => x.classList.remove('player'))
        for(let player of gameState.players){
            var playerSpace = document.getElementById(`hex-${player.row}-${player.col}`)
            playerSpace.classList = 'hexfield player'
        }
    }

    async function handleLobbyInfoMessage(messageData) {
        if (!thisPlayer) {
            thisPlayer = messageData.playerID
            console.log(thisPlayer)
        }
        document.getElementById("lobby-roomCode").innerText = `Room Code: ${messageData.lobbyInfo.roomCode}`

        //#region Player List Rendering
        var playerList = document.getElementById("lobby-playerList")
        playerList.replaceChildren() //Important: Clear the player list so new players joining don't cause duplicate rendering

        for (let player of messageData.lobbyInfo.players) {
            playerEntry = document.createElement("div")
            playerEntry.innerText = player.name
            playerEntry.style.border = "1px solid black"

            playerList.appendChild(playerEntry)
        }
        //#endregion

        //#region Start Game Button
        if (thisPlayer?.length > 0 && thisPlayer == messageData.lobbyInfo?.host?.id) {
            var startButton = document.getElementById("lobby-startButton")
            startButton.style.display = '';
            startButton.onclick = () => {
                config = {
                    numHumans: 0,
                    numAliens: 0,
                    numWorkingPods: 0,
                    numBrokenPods: 0
                }
                config.numHumans = parseInt(document.getElementById("config-numHumans")?.value ?? 0)
                config.numAliens = parseInt(document.getElementById("config-numAliens")?.value ?? 0)
                config.numWorkingPods = parseInt(document.getElementById("config-numWorkingPods")?.value ?? 0)
                config.numBrokenPods = parseInt(document.getElementById("config-numBrokenPods")?.value ?? 0)
                sendWsMessage(ws, 'startGame', config)
            }


        }
        //#endregion
    }

    openSocket();
    // var lobby = {"type":"LobbyInfo","data":{"playerID":"1736982926867JZTAZ5F8TB","lobbyInfo":{"roomCode":"TTWQ","mapId":"1736982914988TDU0HZGRU9","gameStateId":"","status":"Awaiting Start","numPlayers":1,"maxPlayers":12,"players":[{"id":"1736982926867JZTAZ5F8TB","name":"Ryan","team":"","role":"","row":0,"col":0}],"host":{"id":"1736982926867JZTAZ5F8TB","name":"Ryan","team":"","role":"","row":0,"col":0}}}}	
    // handleLobbyInfoMessage(lobby.data)
</script>
{{end}}